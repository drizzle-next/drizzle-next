import { eq } from "drizzle-orm";
import { betterSqlite, sdb } from "./sdb";
import { users } from "@/schema/users";
import { roles, usersRoles } from "@/schema/roles";

async function main() {
  const email = process.argv[2];

  const userRecord = await sdb.query.users.findFirst({
    where: eq(users.email, email),
  });

  if (!userRecord) {
    throw new Error("user not found " + email);
  }

  await sdb.insert(roles).values({ name: "admin" }).onConflictDoNothing();

  const roleRecord = await sdb.query.roles.findFirst({
    where: eq(roles.name, "admin"),
  });

  if (!roleRecord) {
    throw new Error("role not found " + "admin");
  }

  await sdb
    .insert(usersRoles)
    .values({ user_id: userRecord.id, role_id: roleRecord.id });

  await betterSqlite.close();
}

main();
