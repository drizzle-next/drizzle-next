import { eq } from "drizzle-orm";
import { openConnection } from "./sdb";
import { users } from "@/schema/users";
import { roles, usersRoles } from "@/schema/roles";

async function main() {
  const { sdb, closeConnection } = await openConnection();

  const email = process.argv[2];

  const userRecord = await sdb.query.users.findFirst({
    where: eq(users.email, email),
  });

  if (!userRecord) {
    throw new Error("user not found " + email);
  }

  let roleRecord = await sdb.query.roles.findFirst({
    where: eq(roles.name, "admin"),
  });

  if (!roleRecord) {
    await sdb.insert(roles).values({ name: "admin" });
  }

  roleRecord = await sdb.query.roles.findFirst({
    where: eq(roles.name, "admin"),
  });

  if (!roleRecord) {
    throw new Error("role record not found");
  }

  await sdb
    .insert(usersRoles)
    .values({ user_id: userRecord.id, role_id: roleRecord.id });

  await closeConnection();
}

main();
